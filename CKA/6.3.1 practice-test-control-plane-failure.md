### The cluster is broken. We tried deploying an application but it's not working. Troubleshoot and fix the issue.


Start looking at the deployments.

Check the status of all control plane components and identify the component's pod which has an issue.


-------

Run the command: kubectl get pods -n kube-system and check the status of kube-scheduler pod.
We need to check the kube-scheduler manifest file to fix the issue.



The command run by the scheduler pod is incorrect. Here is a snippet of the YAML file.

    spec:
      containers:
      - command:
        - kube-scheduler
        - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf
        - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf
        - --bind-address=127.0.0.1
        - --kubeconfig=/etc/kubernetes/scheduler.conf
        - --leader-elect=true
        ....
Once this is corrected, the scheduler pod will be recreated.


```ruby
controlplane ~ ➜  cat /etc/kubernetes/manifests/
etcd.yaml                     kube-controller-manager.yaml  kube-scheduler.yaml
kube-apiserver.yaml           .kubelet-keep                 

controlplane ~ ➜  cat /etc/kubernetes/manifests/
etcd.yaml                     kube-controller-manager.yaml  kube-scheduler.yaml
kube-apiserver.yaml           .kubelet-keep                 

controlplane ~ ➜  cat /etc/kubernetes/manifests/kube-scheduler.yaml 
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: kube-scheduler
    tier: control-plane
  name: kube-scheduler
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-schedulerrrr
    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf
    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf
    - --bind-address=127.0.0.1
    - --kubeconfig=/etc/kubernetes/scheduler.conf
    - --leader-elect=true
    image: registry.k8s.io/kube-scheduler:v1.29.0
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: 8
      httpGet:
        host: 127.0.0.1
        path: /healthz
        port: 10259
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    name: kube-scheduler
    resources:
      requests:
        cpu: 100m
    startupProbe:
      failureThreshold: 24
      httpGet:
        host: 127.0.0.1
        path: /healthz
        port: 10259
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    volumeMounts:
    - mountPath: /etc/kubernetes/scheduler.conf
      name: kubeconfig
      readOnly: true
  hostNetwork: true
  priority: 2000001000
  priorityClassName: system-node-critical
  securityContext:
    seccompProfile:
      type: RuntimeDefault
  volumes:
  - hostPath:
      path: /etc/kubernetes/scheduler.conf
      type: FileOrCreate
    name: kubeconfig
status: {}

controlplane ~ ➜  vi /etc/kubernetes/manifests/kube-scheduler.yaml 

controlplane ~ ➜  k get all
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-2ktpt   0/1     Pending   0          20m

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   25m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   0/1     1            0           20m

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   1         1         0       20m

controlplane ~ ➜  k get pod -n kube-system 
NAME                                   READY   STATUS    RESTARTS   AGE
coredns-69f9c977-4jtb2                 1/1     Running   0          25m
coredns-69f9c977-rs97l                 1/1     Running   0          25m
etcd-controlplane                      1/1     Running   0          25m
kube-apiserver-controlplane            1/1     Running   0          25m
kube-controller-manager-controlplane   1/1     Running   0          25m
kube-proxy-7c6sj                       1/1     Running   0          25m
kube-scheduler-controlplane            0/1     Running   0          11s

controlplane ~ ➜  k get pod -n kube-system 
NAME                                   READY   STATUS    RESTARTS   AGE
coredns-69f9c977-4jtb2                 1/1     Running   0          25m
coredns-69f9c977-rs97l                 1/1     Running   0          25m
etcd-controlplane                      1/1     Running   0          25m
kube-apiserver-controlplane            1/1     Running   0          26m
kube-controller-manager-controlplane   1/1     Running   0          25m
kube-proxy-7c6sj                       1/1     Running   0          25m
kube-scheduler-controlplane            0/1     Running   0          19s

controlplane ~ ➜  k get pod -n kube-system 
NAME                                   READY   STATUS    RESTARTS   AGE
coredns-69f9c977-4jtb2                 1/1     Running   0          25m
coredns-69f9c977-rs97l                 1/1     Running   0          25m
etcd-controlplane                      1/1     Running   0          26m
kube-apiserver-controlplane            1/1     Running   0          26m
kube-controller-manager-controlplane   1/1     Running   0          26m
kube-proxy-7c6sj                       1/1     Running   0          25m
kube-scheduler-controlplane            1/1     Running   0          25s

controlplane ~ ➜  k get pod
NAME                   READY   STATUS    RESTARTS   AGE
app-5646649cc9-2ktpt   1/1     Running   0          21m

controlplane ~ ➜  
```


### Scale the deployment app to 2 pods.


Run the command: 

        kubectl scale deploy app --replicas=2



```ruby

controlplane ~ ➜  k get all
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-t7h8x   1/1     Running   0          4m8s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   15m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   1/1     1            1           4m8s

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   1         1         1       4m8s

controlplane ~ ➜  k scale deployment app --replicas=2
deployment.apps/app scaled

controlplane ~ ➜  k get all
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-t7h8x   1/1     Running   0          7m11s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   18m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   1/2     1            1           7m11s

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   1         1         1       7m11s

controlplane ~ ➜  k get all
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-t7h8x   1/1     Running   0          7m26s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   18m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   1/2     1            1           7m26s

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   1         1         1       7m26s

controlplane ~ ➜  k get all
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-t7h8x   1/1     Running   0          7m32s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   18m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   1/2     1            1           7m32s

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   1         1         1       7m32s

controlplane ~ ➜  k describe deployments.apps app 
Name:                   app
Namespace:              default
CreationTimestamp:      Mon, 20 May 2024 04:25:52 +0000
Labels:                 app=app
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               app=app
Replicas:               2 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=app
  Containers:
   nginx:
    Image:        nginx:alpine
    Port:         <none>
    Host Port:    <none>
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   app-5646649cc9 (1/1 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  8m22s  deployment-controller  Scaled up replica set app-5646649cc9 to 1

controlplane ~ ➜  k get all
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-t7h8x   1/1     Running   0          8m41s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   19m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   1/2     1            1           8m41s

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   1         1         1       8m41s

controlplane ~ ➜  k get all
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-t7h8x   1/1     Running   0          9m16s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   20m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   1/2     1            1           9m16s

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   1         1         1       9m16s



```


### Even though the deployment was scaled to 2, the number of PODs does not seem to increase. Investigate and fix the issue.


Inspect the component responsible for managing ```deployments``` and ```replicasets```.



Run the command: ```kubectl get po -n kube-system``` and check the logs of kube-controller-manager pod to know the failure reason by running command: ```kubectl logs -n kube-system kube-controller-manager-controlplane```

Then check the kube-controller-manager configuration file at /etc/kubernetes/manifests/kube-controller-manager.yaml and fix the issue.

        root@controlplane:/etc/kubernetes/manifests# kubectl -n kube-system logs kube-controller-manager-controlplane
        I0916 13:10:47.059336       1 serving.go:348] Generated self-signed cert in-memory
        stat /etc/kubernetes/controller-manager-XXXX.conf: no such file or directory

        root@controlplane:/etc/kubernetes/manifests# 
        The configuration file specified (/etc/kubernetes/controller-manager-XXXX.conf) does not exist.
        Correct the path: /etc/kubernetes/controller-manager.conf



```ruby
controlplane /etc/kubernetes ➜  k get pod -n kube-system 
NAME                                   READY   STATUS             RESTARTS      AGE
coredns-69f9c977-88s47                 1/1     Running            0             37m
coredns-69f9c977-vkp8z                 1/1     Running            0             37m
etcd-controlplane                      1/1     Running            0             37m
kube-apiserver-controlplane            1/1     Running            0             37m
kube-controller-manager-controlplane   0/1     CrashLoopBackOff   9 (40s ago)   26s
kube-proxy-6lnm2                       1/1     Running            0             37m
kube-scheduler-controlplane            1/1     Running            0             22m

controlplane /etc/kubernetes ➜  k create -f /tmp/kubectl-edit-206893329.yaml 
Error from server (AlreadyExists): error when creating "/tmp/kubectl-edit-206893329.yaml": pods "kube-controller-manager-controlplane" already exists

controlplane /etc/kubernetes ✖ ls
admin.conf               kubelet.conf  pki             super-admin.conf
controller-manager.conf  manifests     scheduler.conf

controlplane /etc/kubernetes ➜  cd manifests/

controlplane /etc/kubernetes/manifests ➜  ls
etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml

controlplane /etc/kubernetes/manifests ➜  cat kube-
cat: kube-: No such file or directory

controlplane /etc/kubernetes/manifests ✖ cat kube-controller-manager.yaml 
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: kube-controller-manager
    tier: control-plane
  name: kube-controller-manager
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-controller-manager
    - --allocate-node-cidrs=true
    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --bind-address=127.0.0.1
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --cluster-cidr=10.244.0.0/16
    - --cluster-name=kubernetes
    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
    - --controllers=*,bootstrapsigner,tokencleaner
    - --kubeconfig=/etc/kubernetes/controller-manager-XXXX.conf
    - --leader-elect=true
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
    - --root-ca-file=/etc/kubernetes/pki/ca.crt
    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
    - --service-cluster-ip-range=10.96.0.0/12
    - --use-service-account-credentials=true
    image: registry.k8s.io/kube-controller-manager:v1.29.0
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: 8
      httpGet:
        host: 127.0.0.1
        path: /healthz
        port: 10257
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    name: kube-controller-manager
    resources:
      requests:
        cpu: 200m
    startupProbe:
      failureThreshold: 24
      httpGet:
        host: 127.0.0.1
        path: /healthz
        port: 10257
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    volumeMounts:
    - mountPath: /etc/ssl/certs
      name: ca-certs
      readOnly: true
    - mountPath: /etc/ca-certificates
      name: etc-ca-certificates
      readOnly: true
    - mountPath: /usr/libexec/kubernetes/kubelet-plugins/volume/exec
      name: flexvolume-dir
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
      readOnly: true
    - mountPath: /etc/kubernetes/controller-manager.conf
      name: kubeconfig
      readOnly: true
    - mountPath: /usr/local/share/ca-certificates
      name: usr-local-share-ca-certificates
      readOnly: true
    - mountPath: /usr/share/ca-certificates
      name: usr-share-ca-certificates
      readOnly: true
  hostNetwork: true
  priority: 2000001000
  priorityClassName: system-node-critical
  securityContext:
    seccompProfile:
      type: RuntimeDefault
  volumes:
  - hostPath:
      path: /etc/ssl/certs
      type: DirectoryOrCreate
    name: ca-certs
  - hostPath:
      path: /etc/ca-certificates
      type: DirectoryOrCreate
    name: etc-ca-certificates
  - hostPath:
      path: /usr/libexec/kubernetes/kubelet-plugins/volume/exec
      type: DirectoryOrCreate
    name: flexvolume-dir
  - hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
    name: k8s-certs
  - hostPath:
      path: /etc/kubernetes/controller-manager.conf
      type: FileOrCreate
    name: kubeconfig
  - hostPath:
      path: /usr/local/share/ca-certificates
      type: DirectoryOrCreate
    name: usr-local-share-ca-certificates
  - hostPath:
      path: /usr/share/ca-certificates
      type: DirectoryOrCreate
    name: usr-share-ca-certificates
status: {}

controlplane /etc/kubernetes/manifests ➜  vi kube-controller-manager.yaml 

controlplane /etc/kubernetes/manifests ➜  k get all
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-t7h8x   1/1     Running   0          30m

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   41m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   1/2     1            1           30m

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   1         1         1       30m

controlplane /etc/kubernetes/manifests ➜  k get pod -n kube-system 
NAME                                   READY   STATUS    RESTARTS   AGE
coredns-69f9c977-88s47                 1/1     Running   0          41m
coredns-69f9c977-vkp8z                 1/1     Running   0          41m
etcd-controlplane                      1/1     Running   0          41m
kube-apiserver-controlplane            1/1     Running   0          41m
kube-controller-manager-controlplane   0/1     Running   0          11s
kube-proxy-6lnm2                       1/1     Running   0          41m
kube-scheduler-controlplane            1/1     Running   0          26m

controlplane /etc/kubernetes/manifests ➜  k get pod
NAME                   READY   STATUS    RESTARTS   AGE
app-5646649cc9-df2f9   1/1     Running   0          3s
app-5646649cc9-t7h8x   1/1     Running   0          30m

controlplane /etc/kubernetes/manifests ➜  k get all 
NAME                       READY   STATUS    RESTARTS   AGE
pod/app-5646649cc9-df2f9   1/1     Running   0          14s
pod/app-5646649cc9-t7h8x   1/1     Running   0          30m

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   42m

NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/app   2/2     2            2           30m

NAME                             DESIRED   CURRENT   READY   AGE
replicaset.apps/app-5646649cc9   2         2         2       30m

controlplane /etc/kubernetes/manifests ➜  ls
etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml

controlplane /etc/kubernetes/manifests ➜  cat kube-controller-manager.yaml 
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: kube-controller-manager
    tier: control-plane
  name: kube-controller-manager
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-controller-manager
    - --allocate-node-cidrs=true
    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf
    - --bind-address=127.0.0.1
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --cluster-cidr=10.244.0.0/16
    - --cluster-name=kubernetes
    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
    - --controllers=*,bootstrapsigner,tokencleaner
    - --kubeconfig=/etc/kubernetes/controller-manager.conf
    - --leader-elect=true
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt
    - --root-ca-file=/etc/kubernetes/pki/ca.crt
    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
    - --service-cluster-ip-range=10.96.0.0/12
    - --use-service-account-credentials=true
    image: registry.k8s.io/kube-controller-manager:v1.29.0
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: 8
      httpGet:
        host: 127.0.0.1
        path: /healthz
        port: 10257
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    name: kube-controller-manager
    resources:
      requests:
        cpu: 200m
    startupProbe:
      failureThreshold: 24
      httpGet:
        host: 127.0.0.1
        path: /healthz
        port: 10257
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    volumeMounts:
    - mountPath: /etc/ssl/certs
      name: ca-certs
      readOnly: true
    - mountPath: /etc/ca-certificates
      name: etc-ca-certificates
      readOnly: true
    - mountPath: /usr/libexec/kubernetes/kubelet-plugins/volume/exec
      name: flexvolume-dir
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
      readOnly: true
    - mountPath: /etc/kubernetes/controller-manager.conf
      name: kubeconfig
      readOnly: true
    - mountPath: /usr/local/share/ca-certificates
      name: usr-local-share-ca-certificates
      readOnly: true
    - mountPath: /usr/share/ca-certificates
      name: usr-share-ca-certificates
      readOnly: true
  hostNetwork: true
  priority: 2000001000
  priorityClassName: system-node-critical
  securityContext:
    seccompProfile:
      type: RuntimeDefault
  volumes:
  - hostPath:
      path: /etc/ssl/certs
      type: DirectoryOrCreate
    name: ca-certs
  - hostPath:
      path: /etc/ca-certificates
      type: DirectoryOrCreate
    name: etc-ca-certificates
  - hostPath:
      path: /usr/libexec/kubernetes/kubelet-plugins/volume/exec
      type: DirectoryOrCreate
    name: flexvolume-dir
  - hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
    name: k8s-certs
  - hostPath:
      path: /etc/kubernetes/controller-manager.conf
      type: FileOrCreate
    name: kubeconfig
  - hostPath:
      path: /usr/local/share/ca-certificates
      type: DirectoryOrCreate
    name: usr-local-share-ca-certificates
  - hostPath:
      path: /usr/share/ca-certificates
      type: DirectoryOrCreate
    name: usr-share-ca-certificates
status: {}

controlplane /etc/kubernetes/manifests ➜  
```
